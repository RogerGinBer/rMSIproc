#########################################################################
#     
#     Copyright (C) 2018 Lluc Semente Fernandez
# 
#     This program is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
# 
#     This program is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
# 
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
############################################################################

#' peakAnnotation
#' 
#' Searches for isotopic ions in the peak matrix and evaluates them using morphology, intensity and mass error criteria.
#' This algorithm only searches carbon-based isotopic ions.
#' Using the infromation generated by the isotopes test, the algorithm then proceeds to search adduct pairs between the monoisotopic ions.
#' 
#' @param PeakMtx List. An rMSIprocPeakMatrix. Must contain at least the following categories: \itemize{
#' \item PeakMtx$intensity. A matrix containg the intensities of the peaks for each pixel (rows = pixels, cols = ions).  
#' \item PeakMtx$mass. A vector containg the masses of each peak. Must be in the same order with the columns of the intensity marix.   
#' \item PeakMtx$numPixels. Number of pixels (rows in your matrix).   
#' }
#' @param iso.number Integer. Number of isotopes to be found.
#' @param iso.tolerance Integer. Mass tolerance for the isotope candidates in scans or ppms.
#' @param iso.scoreThreshold Numeric. Score value to consider a ion mass a good isotope candidate. Only the ions that have this number or greater will undergo the following isotope searching stages.
#' @param iso.toleranceUnits String. Must be 'ppm' or 'scan'. If ToleranceUnits is 'scan' then ImageVector must be the mass channels vector of the rMSI image (rMSIObj$mass).
#' @param iso.imageVector Numeric Vector. The mass channels vector of the imaging dataset containing all the scans.
#' 
#' @param add.adductDataFrame Data frame with two columns.\itemize{
#'  \item $name. Column containing the names as strings of the elements or molecules that form adducts 
#'  \item $mass. Masses of the adduct forming elements.
#'  }
#' @param add.tolerance Integer. Mass error tolerance in ppm.
#' @return A list of lists. All the infomarion related with the isotopes can be found in $isotopes sub-list, and the same for adducts in the $adducts sub-list.
#' \itemize{
#'   \item $isotopes: List of lists. Contains the followin sub-lists:
#'    \itemize{
#'    \item $Mn: List of matrices. Contains all the M+n ions evaluated and the results matrix. The name of the lists referes to the peak selected as monoisotopic.
#'    \item $isotopicPeaks: Vector. Indices of the mass vector beloning to isotopic peaks.
#'    \item $monoisotopicPeaks: Vector. Indices of the mass vector beloning to monoisotopic peaks.
#'   }
#'   \item $adducts: List of matrices. Contains all the adduct pairs found during the test. The names refer to the neutral masses of the hypothetic ions.
#' }
#' @export
#' 
peakAnnotation <- function(PeakMtx, 
                           iso.number = 2, 
                           iso.tolerance = 30, 
                           iso.scoreThreshold = 0.75,
                           iso.toleranceUnits = "ppm",
                           iso.imageVector = NULL,
                           add.tolerance = 50,
                           add.adducts = data.frame(mass = c(38.963706,22.98976,1.007825),
                                                    name = c("K","Na","H")))
{
  result <- list()
  
  isotopeObj <- isotopeAnnotation(PeakMtx, isoNumber = iso.number, tolerance = iso.tolerance,
                                  scoreThreshold = iso.scoreThreshold, toleranceUnits = iso.toleranceUnits,
                                  imageVector = iso.imageVector)

  if(length(isotopeObj$monoisotopicPeaks) >= 2)
  {
    adductObj <- adductAnnotation(isotopeObj = isotopeObj, PeakMtx = PeakMtx,
                                  adductDataFrame = add.adducts,tolerance = add.tolerance)
    result$adducts <- adductObj
  }
  
  result$isotopes <- isotopeObj
  
  result$parameters <- list(isotope_number = iso.number,
                             isotope_mass_tolerance = iso.tolerance,
                             isotope_score_threshold = iso.scoreThreshold,
                             isotope_tolerance_units = iso.toleranceUnits,
                             adduct_mass_tolerance = add.tolerance,
                             adduct_ions = add.adducts)
  
  return(result)
}









